<!DOCTYPE html>
<html>
<head>
	<title><%= title %> | Gists.io</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="/favicon.ico" rel="icon">
	<!-- Bootstrap -->
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" media="screen">
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
	<link rel="stylesheet" href="/s/css/main.css" id="main-style">
	<link href="//fonts.googleapis.com/css?family=Open+Sans:700,400,300|Roboto:400,700,900,300|Roboto+Slab:400,300&amp;subset=latin" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/s/css/monokai_sublime.css">
	<link rel="stylesheet" href="/s/css/codemirror.css">
	<link rel="stylesheet" href="/s/css/monokai.css">
	<link rel="stylesheet" href="/s/css/sir-trevor.css">
	<link rel="stylesheet" href="/s/css/sir-trevor-icons.css">
	<link rel="stylesheet" href="/s/css/gio.css">
</head>
<body>
<header>
	<nav class="navbar nav-white navbar-fixed-top" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle gists-navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
			<span class="sr-only">Toggle navigation</span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			</button>

			<a class="navbar-brand logo" href="/">gists.io</a>
		</div>
		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse navbar-ex1-collapse">
			<form class="navbar-form navbar-right nav-search" role="search">
				<div class="form-group">
					<input type="text" class="form-control input-sm" placeholder="Search by #hashtag">
				</div>
				<%= if is_loggedin != false do %>
					<a href="/logout" class="btn btn-primary">Log out</a>
					<a href="/<%= is_loggedin %>/new" class="btn btn-primary">Create a gist</a>
				<%= else %>
				<a class="btn btn-success btn-sm" href="/login">SIGN IN <i class="icon-github"></i></a>
				<%= end %>
			</form>

			<ul class="nav navbar-nav navbar-right gists-navbar-nav">
				<li><a href="/">Home</a></li>
				<li><a href="#">Features</a></li>
				<li><a href="#">Expore</a></li>
				<li><a href="#">Contact</a></li>
			</ul>
		</div>
		<!-- /.navbar-collapse -->
	</nav>
</header>

<main role="main" class="main">
	<section class="container">
		<div class="row">
			<div class="col-md-9 col-lg-9">
				<%= content %>
			</div>
			<%= sidebar %>
		</div>
	</section>
</main>

<footer class="text-right">
	<p>&copy; InHuman 2013</p>	
</footer>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

<script src="/s/js/marked.js"></script>
<script src="/s/js/highlight.pack.js"></script>
<script src="/s/js/codemirror-compressed.js"></script>
<script src="/s/js/underscore.js"></script>
<script src="/s/js/eventable.js"></script>
<script src="/s/js/sir-trevor.js"></script>
<script src="/s/js/code-block.js"></script>
<script src="/s/js/markdown-block.js"></script>
<script src="/s/js/teaser-block.js"></script>
<script src="/s/js/image-block.js"></script>
<script src="/s/js/jquery.timeago.js"></script>
<script src="/s/js/embeddable-mixin.js"></script>

<script>
function is_image(name, content) {
	return /(?:\.jpg|jpeg|png|gif)/.test(name) && /data:image\/.+;base64.+/.test(content);
}
function to_blocks(markdown) {
	var result = {}, blocks = markdown.split(/(?:[\r\n]*|<br\s?\/?>*)(```.+\n[\s\S]+?\n```|(?:\s-\s.+\n)+)(?:[\r\n]*|<br\s?\/?>*)/g);
	var $teaser = $(".gio-teaser"), teaser = $teaser.html();
	var data = [];
	if (teaser !== "") {
		data.push({type: "teaser", data: {text: teaser}});
	}
	var numBlocks = blocks.length;
	result.data = data.concat(blocks.filter(function(text){
		return numBlocks === 1 || text !== "";
	}).map(function(text) {
		var matches = text.match(/```(.+)\n([\s\S]*)\n```/);
		if (matches && matches[1] && matches[2]) {
			var name = matches[1], content = matches[2];
			return { 
				type: is_image(name, content)? "image": "code", 
				data: { 
					source: content, 
					name: name 
				} 
			};
		}
		matches = text.match(/(?:\s-\s.+\n)+/);
		if (matches && matches[0]) {
			return { type: "list", data: { text: matches[0] } };
		}
		return { type: "markdown", data: { text: text } };
	}));
	return result;
}

$(function() {
	$("time.timeago").timeago();

	var $editor = $('.gio-entry');
	$editor.each(function() {
		var markdown = $editor.text(),
			blocksData = to_blocks(markdown);
		$editor.val(JSON.stringify(blocksData));

		new SirTrevor.Editor({ 
			el: $editor,
			blockTypes: ["Markdown","Code","List", "Teaser", "Image"],
			blockTypeLimits: {"Teaser":1},
			required: ["Markdown"]
		});

		marked.setOptions({
	    	highlight: function(code, lang){
	        	// More info at http://softwaremaniacs.org/soft/highlight/en/download/
	        	return hljs.LANGUAGES[lang] ? hljs.highlight(lang, code).value : code;
	    	}
		});
	});

	$('a.style-option').click(function(e) {
		e.preventDefault();
		var _this = $(this),
			_link = $('#main-style'),
			_href = _link.prop('href'),
			_url = _href.substring(0, _href.lastIndexOf('/'));
		
		_link.prop('href', _url + '/' + _this.data('style') + '.css');
	});
});
</script>

</body>
</html>