<!DOCTYPE html>
<html>
<head>
	<title><%= title %> | Gists.io</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="/s/favicon.ico" rel="icon">
	<!-- Bootstrap -->
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" media="screen">
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css">
	<link rel="stylesheet" href="/s/css/monokai_sublime.css">
	<link rel="stylesheet" href="/s/css/codemirror.css">
	<link rel="stylesheet" href="/s/css/monokai.css">
	<link rel="stylesheet" href="/s/css/sir-trevor.css">
	<link rel="stylesheet" href="/s/css/sir-trevor-icons.css">
	<link href="//fonts.googleapis.com/css?family=Roboto:400,700,900,300|Roboto+Slab:400,300&amp;subset=latin" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/s/css/light.css" id="main-style">
	<link rel="stylesheet" href="/s/css/gio.css">
</head>
<body>
<div class="container">
	<div class="main">
		<div class="row">
			<div class="col-md-9 col-lg-9">
				<div class="content">
					<%= if is_loggedin != false do %>
						<a class="logout" href="/logout?redirect=">Log out</a>
						<a href="/<%= is_loggedin %>/new" class="btn btn-primary">Create a gist</a>
					<%= else %>
						<a class="login" href="/login?redirect=">Log in</a>
					<%= end %>
					<h1><%= title %></h1> 

					<%= content %>

				</div>
			</div>
			<%= sidebar %>
		</div>
	</div>
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="//code.jquery.com/jquery.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="/s/js/marked.js"></script>
<script src="/s/js/highlight.pack.js"></script>
<script src="/s/js/codemirror-compressed.js"></script>
<script src="/s/js/underscore.js"></script>
<script src="/s/js/eventable.js"></script>
<script src="/s/js/sir-trevor.js"></script>
<script src="/s/js/code-block.js"></script>
<script src="/s/js/markdown-block.js"></script>
<script src="/s/js/teaser-block.js"></script>
<script src="/s/js/image-block.js"></script>
<script src="/s/js/jquery.timeago.js"></script>

<script>
function is_image(name, content) {
	return /(?:\.jpg|jpeg|png|gif)/.test(name) && /data:image\/.+;base64.+/.test(content);
}
function to_blocks(markdown) {
	var result = {}, blocks = markdown.split(/[\r\n]*(```.+\n[\s\S]+?\n```)[\r\n]*/g);
	var $teaser = $(".gio-teaser"), teaser = $teaser.html();
	var data = [];
	if (teaser !== "") {
		data.push({type: "teaser", data: {text: teaser}});
	}
	var numBlocks = blocks.length;
	result.data = data.concat(blocks.filter(function(text){
		return numBlocks === 1 || text !== "";
	}).map(function(text) {
		var matches = text.match(/```(.+)\n([\s\S]*)\n```/);
		if (matches && matches[1] && matches[2]) {
			var name = matches[1], content = matches[2];
			return { 
				type: is_image(name, content)? "image": "code", 
				data: { 
					source: content, 
					name: name 
				} 
			};
		}
		return { type: "markdown", data: { text: text } };
	}));
	return result;
}

$(function() {
	$("time.timeago").timeago();

	var $editor = $('.blog'), markdown = $editor.text(),
		blocksData = to_blocks(markdown);
	$editor.val(JSON.stringify(blocksData));

	new SirTrevor.Editor({ 
		el: $editor,
		blockTypes: ["Markdown","Code","Teaser", "Image"],
		blockTypeLimits: {"Teaser":1},
		required: ["Markdown"]
	});

	marked.setOptions({
    	highlight: function(code, lang){
        	// More info at http://softwaremaniacs.org/soft/highlight/en/download/
        	return hljs.LANGUAGES[lang] ? hljs.highlight(lang, code).value : code;
    	}
	});

	$('a.style-option').click(function(e) {
		e.preventDefault();
		var _this = $(this),
			_link = $('#main-style'),
			_href = _link.prop('href'),
			_url = _href.substring(0, _href.lastIndexOf('/'));
		
		_link.prop('href', _url + '/' + _this.data('style') + '.css');
	});
});
</script>

</body>
</html>